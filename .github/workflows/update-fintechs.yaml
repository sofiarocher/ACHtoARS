name: Update fintechs_arg Table

on:
  schedule:
    - cron: '*/5 * * * *' # every 5 min
  workflow_dispatch:

jobs:
  update-fintechs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Update fintechs_arg Table in Supabase
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        # Obtener los datos de la API CriptoYa
        response=$(curl -s https://criptoya.com/api/exchanges)
        
        # Filtra solo los exchanges que te interesan
        echo $response | jq '{ 
          exchanges: [
            { name: "lemoncash", rate: .lemoncash.bid },
            { name: "belo", rate: .belo.bid },
            { name: "cocoscrypto", rate: .cocoscrypto.bid },
            { name: "takenos", rate: .takenos.bid },
            { name: "astropay", rate: .astropay.bid }
          ]
        }' > fintechs.json

        # Itera sobre los exchanges y actualiza la tabla en Supabase
        for row in $(jq -c '.exchanges[]' fintechs.json); do
          NAME=$(echo "$row" | jq -r '.name')
          RATE=$(echo "$row" | jq -r '.rate')

          # Inserta o actualiza los datos en la tabla fintechs_arg
          curl -X POST "${NEXT_PUBLIC_SUPABASE_URL}/rest/v1/fintechs_arg" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "{\"name\":\"${NAME}\",\"rate\":${RATE}}"
        done